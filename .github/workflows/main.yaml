name: main

on:
  push:
    branches: ["main"]
    paths: ["public/**"]

permissions:
  contents: read
 
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:

  define-actions:
    runs-on: gha-runner-scale-set-arm64
    outputs:
      skip_create_tag: ${{ steps.check-skip.outputs.skip_create_tag }}
      skip_build_push_image: ${{ steps.check-skip.outputs.skip_build_push_image }}
      skip_deploy_aws: ${{ steps.check-skip.outputs.skip_deploy_aws }}
      skip_deploy_k8s: ${{ steps.check-skip.outputs.skip_deploy_k8s }}
    steps:
      - name: Set skip values
        id: check-skip
        run: |
          if echo "${{ github.event.head_commit.message }}" | grep -q -- "--create-tag"; then
            echo "skip_create_tag=false" >> $GITHUB_OUTPUT
          else
            echo "skip_create_tag=true" >> $GITHUB_OUTPUT
          fi
          if echo "${{ github.event.head_commit.message }}" | grep -q -- "--skip-build-push-imageg"; then
            echo "skip_build_push_image=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build_push_image=false" >> $GITHUB_OUTPUT
          fi
          if echo "${{ github.event.head_commit.message }}" | grep -q -- "--skip-deploy-aws"; then
            echo "skip_deploy_aws=true" >> $GITHUB_OUTPUT
          else
            echo "skip_deploy_aws=false" >> $GITHUB_OUTPUT
          fi
          if echo "${{ github.event.head_commit.message }}" | grep -q -- "--deploy-k8s"; then
            echo "skip_deploy_k8s=true" >> $GITHUB_OUTPUT
          else
            echo "skip_deploy_k8s=false" >> $GITHUB_OUTPUT
          fi
      - name: Debug
        run: |
          echo "Commit msg: ${{ github.event.head_commit.message }}"
          echo "skip_create_tag is set to ${{ steps.check-skip.outputs.skip_create_tag }}"
          echo "skip_build_push_image is set to ${{ steps.check-skip.outputs.skip_build_push_image }}"
          echo "skip_deploy_aws is set to ${{ steps.check-skip.outputs.skip_deploy_aws }}"
          echo "skip_deploy_k8s is set to ${{ steps.check-skip.outputs.skip_deploy_k8s }}"
 
  create-update-version-tag:
    if: ${{ needs.define-actions.outputs.skip_create_tag == 'false' }}
    runs-on: gha-runner-scale-set-arm64
    needs: define-actions
    steps:
      - name: Create or update git tag
        uses: v6Org01/.github/actions/create-git-versionTag@main
        with:
          DEPLOY_PRIVATE_KEY: ${{ secrets.DEPLOY_PRIVATE_KEY }}
          PAT_DEFAULT: ${{ secrets.PAT_DEFAULT }}

  build-push-image:
    if: ${{ !failure() && needs.define-actions.outputs.skip_build_push_image == 'false' }}
    needs: create-update-version-tag
    uses: v6Org01/.github/.github/workflows/buildPushImage.yaml@main
    with:
      APPLICATION: ${{ vars.APPLICATION }}
      BUILD_ARGS: |
        REGISTRY=${{ vars.REGISTRY_PRIVATE_PULL }}
        JLV6_GID=${{ vars.JLV6_GID }}
        JLV6_GROUP=${{ vars.JLV6_GROUP }}
        JLV6_UID=${{ vars.JLV6_UID }}
        JLV6_USER=${{ vars.JLV6_USER }}
      PUSH_TO_PRIVATE: true
      PUSH_TO_PUBLIC: false
      REGISTRY_PRIVATE: ${{ vars.REGISTRY_PRIVATE }}
      REGISTRY_PRIVATE_PULL: ${{ vars.REGISTRY_PRIVATE_PULL }}
      VERSION: ${{ vars.APPLICATION_VERSION }}
    secrets:
      REGISTRY_PRIVATE_USER: ${{ secrets.REGISTRY_PRIVATE_USER01 }}
      REGISTRY_PRIVATE_PASSWD: "${{ secrets.REGISTRY_PRIVATE_USER01_PASSWD }}"

  deploy-to-aws-staging:
    if: ${{ !failure() && needs.define-actions.outputs.skip_deploy_aws == 'false' }}
    needs: create-update-version-tag
    uses: v6Org01/jlv6/.github/workflows/deployStaging2AWS.yaml@main
    with:
      K8S_NAMESPACE_CERT: ${{ vars.K8S_NAMESPACE_CERT }}
      K8S_SECRET_CERT: ${{ vars.K8S_SECRET_CERT }}
      TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
      VERSION: ${{ vars.APPLICATION_VERSION }}
    secrets:
      KUBECONFIG_PLUTO_CERT: ${{ secrets.KUBECONFIG_PLUTO_CERT }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

  # deploy-to-aws-production:
  #   if: ${{ !failure() && needs.define-actions.outputs.skip_deploy_aws == false }}
  #   environment: production
  #   needs: deploy-to-aws-staging
  #   uses: v6Org01/jlv6/.github/workflows/deployProduction2AWS.yaml@main
  #     TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
  #   secrets:
  #     TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
      

  # deploy-to-k8s:
  #   if: ${{ !failure() && needs.define-actions.outputs.skip_deploy_k8s == false }}
  #   needs: build-push-image
  #   uses: v6Org01/jlv6/.github/workflows/deploy2K8S.yaml@main
  #   with:
  #   secrets:
